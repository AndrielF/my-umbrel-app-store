version: "3.7"

services:
  # O Proxy garante que apenas você logado no Umbrel acesse o app
  app_proxy:
    environment:
      APP_HOST: andriel-cronmaster_server_1
      APP_PORT: 3000
      PROXY_AUTH_ADD_NO_AUTH: "false"

  server:
    image: ghcr.io/fccview/cronmaster:main
    container_name: andriel_cronmaster_server_1
    # Mantemos root para poder usar o docker.sock e editar o cron interno
    user: "root"
    restart: on-failure
    stop_grace_period: 1m

    # TRUQUE: Iniciamos o serviço de cron (crond) manualmente antes de subir o site.
    # Como removemos o modo DOCKER=true, precisamos garantir que o relógio interno rode.
    command: sh -c "crond -b && npm start"

    volumes:
      - ${APP_DATA_DIR}/data:/data
      # O Cron interno vai escrever aqui. Isso garante persistência.
      - ${APP_DATA_DIR}/crontabs:/var/spool/cron/crontabs
      # A chave mestra para controlar o Arcane continua aqui
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      # --- MUDANÇAS CRÍTICAS ---
      # Removemos DOCKER=true para ele parar de tentar usar nsenter
      - NODE_ENV=production
      # Removemos HOST_CRONTAB_USER para ele usar o usuário atual (root do container)
      - PORT=3000
      # Define o fuso horário para bater com o servidor (Opcional, mas recomendado)
      - TZ=America/Sao_Paulo
