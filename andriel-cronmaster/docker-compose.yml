version: "3.7"

services:
  # O Proxy garante que apenas você logado no Umbrel acesse o app
  app_proxy:
    environment:
      APP_HOST: andriel-cronmaster_server_1
      APP_PORT: 3000
      PROXY_AUTH_ADD_NO_AUTH: "false"

  server:
    image: ghcr.io/fccview/cronmaster:main
    container_name: andriel_cronmaster_server_1
    # Mantemos root para poder usar o docker.sock e editar o cron interno
    user: "root"
    restart: on-failure
    stop_grace_period: 1m

    # TRUQUE: Script de boot robusto.
    # 1. Tenta rodar 'cron'.
    # 2. Se não existir, instala via apt-get (assumindo base Debian) e roda.
    # 3. Inicia o app.
    command: sh -c "if ! command -v cron > /dev/null; then echo 'Instalando cron...'; apt-get update && apt-get install -y cron; fi; cron && npm start"

    volumes:
      - ${APP_DATA_DIR}/data:/data
      # O Cron interno vai escrever aqui. Isso garante persistência.
      - ${APP_DATA_DIR}/crontabs:/var/spool/cron/crontabs
      # A chave mestra para controlar o Arcane continua aqui
      - /var/run/docker.sock:/var/run/docker.sock

    environment:
      # --- MUDANÇAS CRÍTICAS ---
      # Removemos DOCKER=true para ele parar de tentar usar nsenter
      - NODE_ENV=production
      # Removemos HOST_CRONTAB_USER para ele usar o usuário atual (root do container)
      - PORT=3000
      # Define o fuso horário para bater com o servidor (Opcional, mas recomendado)
      - TZ=America/Sao_Paulo
