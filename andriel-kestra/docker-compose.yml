version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: andriel-kestra_server_1
      APP_PORT: 8080
      PROXY_AUTH_ADD: "false"

  server:
    image: kestra/kestra:latest
    container_name: kestra
    # O modo standalone é mais leve e inclui tudo (Webserver, Executor, Scheduler)
    command: server standalone
    # Rodar como root garante permissões de escrita nos volumes do Umbrel sem dor de cabeça
    user: "root"
    restart: on-failure
    volumes:
      # Persistência dos dados (Flows, Execuções, Logs)
      - ${APP_DATA_DIR}/data:/app/storage
      # Opcional: Para configurações customizadas avançadas
      - ${APP_DATA_DIR}/confs:/app/confs
    environment:
      KESTRA_CONFIGURATION_PATH: /app/confs/application.yml
      # Configurações Críticas que faltavam:
      KESTRA_REPOSITORY_TYPE: fs
      KESTRA_QUEUE_TYPE: fs
      KESTRA_STORAGE_TYPE: local
      # Força a porta interna para 8080
      KESTRA_SERVER_PORT: 8080
      # Plugins e configurações adicionais
      KESTRA_PLUGINS: ""
